# $Id: PKGBUILD 168631 2012-10-13 16:37:23Z thomas $
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Contributor: Wolfgang Bumiller <blub@speed.at>

# This package spans multiple repositories. 
# Always build from cyrus-sasl/trunk and merge changes to libsasl/trunk.

pkgbase=('cyrus-sasl')
pkgname=('cyrus-sasl' 'cyrus-sasl-gssapi' 'cyrus-sasl-ldap' 'cyrus-sasl-sql' 'libsasl')
#pkgname=libsasl
pkgver=2.1.26
pkgrel=8
pkgdesc="Cyrus Simple Authentication Service Layer (SASL) library"
arch=('i686' 'x86_64')
url="http://cyrusimap.web.cmu.edu/"
license=('custom')
options=('!makeflags' 'libtoolfix')
makedepends=('libmariadbclient' 'libldap' 'db' 'sqlite')
source=(ftp://ftp.cyrusimap.org/cyrus-sasl/cyrus-sasl-${pkgver}.tar.gz
        patch-Makefile.in
        patch-config__ltmain.sh
        patch-configure
        patch-include__sasl.h
        patch-plugins__ldapdb.c
        patch-saslauthd__Makefile.in
        patch-saslauthd__configure
        patch-saslauthd__saslcache.c)
md5sums=('a7f4e5e559a0e37b3ffc438c9456e425'
         '3abc193f270d40d161b62dd7f119a979'
         'ac577b3126b4311c2aaa2a698ca98e7f'
         'cad6692411d15f57ac248543e33ea9d1'
         '5a52c3be3affeb9fb1b79e3861b10d60'
         'f8e0c5fb578f1ad45646cf9a467bb4af'
         'b0d10569abda1a8f96989518b4cf81b1'
         '7cb4b0eae7fda2c0ea691ffb00b79db4'
         'd77fcea8493e1662b4b44beefed1a592')

build() {
  cd "${srcdir}/cyrus-sasl-${pkgver}"

  for i in patch-Makefile.in patch-config__ltmain.sh patch-configure patch-include__sasl.h patch-plugins__ldapdb.c patch-saslauthd__Makefile.in patch-saslauthd__configure patch-saslauthd__saslcache.c
  do
    patch -p0 -i "$srcdir/$i"
  done

# We need to fix up a wrong library name
  find . ! -type d -exec sed -i '' -e 's/libsasldb\.al/libsasldb.a/g' '{}' ';'

# These flags are required, LDFLAGS from makepkg.conf *cannot* be used reliably!
  unset CFLAGS
  unset LDFLAGS
  unset CPPFLAGS

      if [ "$CARCH" == "x86_64" ]; then
         conf_args=(--build=amd64-portbld-freebsd10.0 \
                    CPPFLAGS="-fPIC" )
      else
         conf_args=(--build=i386-portbld-freebsd10.0)
      fi

  ./configure --prefix=/usr \
      --mandir=/usr/share/man \
      --infodir=/usr/share/info \
      --enable-static \
      --enable-shared \
      --enable-alwaystrue \
      --enable-checkapop \
      --enable-cram \
      --enable-digest \
      --disable-otp \
      --disable-srp \
      --disable-srp-setpass \
      --disable-krb4 \
      --enable-gssapi \
      --enable-auth-sasldb \
      --enable-plain \
      --enable-anon \
      --enable-login \
      --enable-ntlm \
      --disable-passdss \
      --enable-sql \
      --with-mysql \
      --with-sqlite3=/usr/lib \
      --enable-ldapdb \
      --disable-macos-framework \
      --with-pam \
      --with-saslauthd=/var/run/saslauthd \
      --with-ldap=/usr \
      --with-dblib=berkeley \
      --with-configdir=/etc/sasl2:/etc/sasl:/usr/lib/sasl2 \
      --sysconfdir=/etc \
      --with-plugindir=/usr/lib/sasl2 \
      --with-dbpath=/etc/sasldb2 \
      --with-lib-subdir=lib \
      --with-pkgconfigdir=/usr/lib/pkgconfig \
      --includedir=/usr/include \
      --with-rc=openssl \
      --with-bdb=db-5 \
      --with-authdaemond=/var/run/authdaemond/socket \
      --with-openssl=yes \
      CFLAGS="-O2 -pipe -fno-strict-aliasing" \
      LDFLAGS="-Wl,-rpath,/usr/lib" \
      ${conf_args[@]}

  gmake
}

package_libsasl() {
  pkgdesc="Cyrus Simple Authentication Service Layer (SASL) Library"
  conflicts=('cyrus-sasl-plugins')

  cd "${srcdir}/cyrus-sasl-${pkgver}"
  for dir in include lib sasldb plugins utils; do
    pushd ${dir}
    gmake DESTDIR="${pkgdir}" install
    popd
  done
  rm -f "${pkgdir}"/usr/lib/sasl2/libsql.so*
  rm -f "${pkgdir}"/usr/lib/sasl2/libgssapiv2.so*
  rm -f "${pkgdir}"/usr/lib/sasl2/libldapdb.so*
  install -m755 -d "${pkgdir}/usr/share/licenses/libsasl"
  install -m644 COPYING "${pkgdir}/usr/share/licenses/libsasl/"
}

package_cyrus-sasl() {
  depends=("libsasl=${pkgver}" 'db' 'libldap')
  pkgdesc="Cyrus saslauthd SASL authentication daemon"
  backup=('etc/conf.d/saslauthd')

  cd "${srcdir}/cyrus-sasl-${pkgver}/saslauthd"
  gmake DESTDIR="${pkgdir}" install

  install -m755 -d "${pkgdir}/usr/share/licenses/cyrus-sasl"
  ln -sf ../libsasl/COPYING "${pkgdir}/usr/share/licenses/cyrus-sasl/"
}

package_cyrus-sasl-gssapi() {
  pkgdesc="GSSAPI authentication mechanism for Cyrus SASL"
  depends=("libsasl=${pkgver}")
  replaces=('cyrus-sasl-plugins')

  cd "${srcdir}/cyrus-sasl-${pkgver}/plugins"
  install -m755 -d "${pkgdir}/usr/lib/sasl2"
  cp -a .libs/libgssapiv2.so* "${pkgdir}/usr/lib/sasl2/"

  install -m755 -d "${pkgdir}/usr/share/licenses/cyrus-sasl-gssapi"
  ln -sf ../libsasl/COPYING "${pkgdir}/usr/share/licenses/cyrus-sasl-gssapi/"
}

package_cyrus-sasl-ldap() {
  pkgdesc="ldapdb auxprop module for Cyrus SASL"
  depends=("libsasl=${pkgver}" 'libldap')
  replaces=('cyrus-sasl-plugins')

  cd "${srcdir}/cyrus-sasl-${pkgver}/plugins"
  install -m755 -d "${pkgdir}/usr/lib/sasl2"
  cp -a .libs/libldapdb.so* "${pkgdir}/usr/lib/sasl2/"

  install -m755 -d "${pkgdir}/usr/share/licenses/cyrus-sasl-ldap"
  ln -sf ../libsasl/COPYING "${pkgdir}/usr/share/licenses/cyrus-sasl-ldap/"
}

package_cyrus-sasl-sql() {
  pkgdesc="SQL auxprop module for Cyrus SASL"
  depends=("libsasl=${pkgver}" 'libmariadbclient' 'sqlite')
  replaces=('cyrus-sasl-plugins')

  cd "${srcdir}/cyrus-sasl-${pkgver}/plugins"
  install -m755 -d "${pkgdir}/usr/lib/sasl2"
  cp -a .libs/libsql.so* "${pkgdir}/usr/lib/sasl2/"

  install -m755 -d "${pkgdir}/usr/share/licenses/cyrus-sasl-sql"
  ln -sf ../libsasl/COPYING "${pkgdir}/usr/share/licenses/cyrus-sasl-sql/"
}
