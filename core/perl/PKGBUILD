# Port: lang/perl5.24

pkgname=perl
pkgver=5.24.0
pkgrel=1
pkgdesc="A highly capable, feature-rich programming language"
arch=(i386 amd64)
license=('GPL' 'PerlArtistic')
url="http://www.perl.org"
makedepends=('gsed')
# NOTE: This array is automatically generated by `./patchprov`.
#       If you want to add entries, do so in the next array.
provides=('perl-archive-tar=2.04'
          'perl-attribute-handlers=0.99'
          'perl-autodie=2.29'
          'perl-autoloader=5.74'
          'perl-autouse=1.11'
          'perl-b-debug=1.23'
          'perl-base=2.23'
          'perl-bignum=0.42'
          'perl-carp=1.40'
          'perl-compress-raw-bzip2=2.069'
          'perl-compress-raw-zlib=2.069'
          'perl-config-perl-v=0.25'
          'perl-constant=1.33'
          'perl-cpan-meta-requirements=2.140'
          'perl-cpan-meta-yaml=0.018'
          'perl-cpan-meta=2.150005'
          'perl-cpan=2.11'
          'perl-data-dumper=2.160'
          'perl-db_file=1.835'
          'perl-devel-ppport=3.32'
          'perl-devel-selfstubber=1.05'
          'perl-digest-md5=2.54'
          'perl-digest-sha=5.95'
          'perl-digest=1.17'
          'perl-dumpvalue=1.18'
          'perl-encode=2.80'
          'perl-encoding-warnings=0.12'
          'perl-env=1.04'
          'perl-experimental=0.016'
          'perl-exporter=5.72'
          'perl-extutils-cbuilder=0.280225'
          'perl-extutils-constant=0.23'
          'perl-extutils-install=2.04'
          'perl-extutils-makemaker=7.10_01'
          'perl-extutils-manifest=1.70'
          'perl-extutils-parsexs=3.31'
          'perl-file-fetch=0.48'
          'perl-file-path=2.12_01'
          'perl-file-temp=0.2304'
          'perl-filter-simple=0.92'
          'perl-filter-util-call=1.55'
          'perl-getopt-long=2.48'
          'perl-http-tiny=0.056'
          'perl-i18n-collate=1.02'
          'perl-i18n-langtags=0.40'
          'perl-if=0.0606'
          'perl-io-compress=2.069'
          'perl-io-socket-ip=0.37'
          'perl-io-zlib=1.10'
          'perl-io=1.36'
          'perl-ipc-cmd=0.92'
          'perl-ipc-sysv=2.06_01'
          'perl-json-pp=2.27300'
          'perl-lib=0.63'
          'perl-libnet=3.08'
          'perl-locale-codes=3.37'
          'perl-locale-maketext-simple=0.21'
          'perl-locale-maketext=1.26'
          'perl-math-bigint-fastcalc=0.40'
          'perl-math-bigint=1.999715'
          'perl-math-bigrat=0.260802'
          'perl-math-complex=1.59'
          'perl-memoize=1.03'
          'perl-mime-base64=3.15'
          'perl-module-corelist=5.20160506'
          'perl-module-load-conditional=0.64'
          'perl-module-load=0.32'
          'perl-module-loaded=0.08'
          'perl-module-metadata=1.000031'
          'perl-net-ping=2.43'
          'perl-params-check=0.38'
          'perl-parent=0.234'
          'perl-parse-cpan-meta=1.4417'
          'perl-pathtools=3.63'
          'perl-perl-ostype=1.009'
          'perl-perlfaq=5.021010'
          'perl-perlio-via-quotedprint=0.08'
          'perl-pod-checker=1.60'
          'perl-pod-escapes=1.07'
          'perl-pod-parser=1.63'
          'perl-pod-perldoc=3.25_02'
          'perl-pod-simple=3.32'
          'perl-pod-usage=1.68'
          'perl-podlators=5.006'
          'perl-safe=2.39'
          'perl-scalar-list-utils=1.42_02'
          'perl-search-dict=1.07'
          'perl-selfloader=1.23'
          'perl-socket=2.020_03'
          'perl-storable=2.56'
          'perl-sys-syslog=0.33'
          'perl-term-ansicolor=4.04'
          'perl-term-cap=1.17'
          'perl-term-complete=1.403'
          'perl-term-readline=1.15'
          'perl-test-harness=3.36'
          'perl-test-simple=1.001014'
          'perl-test=1.28'
          'perl-text-abbrev=1.02'
          'perl-text-balanced=2.03'
          'perl-text-parsewords=3.30'
          'perl-text-tabs=2013.0523'
          'perl-thread-queue=3.09'
          'perl-thread-semaphore=2.12'
          'perl-threads-shared=1.51'
          'perl-threads=2.07'
          'perl-tie-file=1.02'
          'perl-tie-refhash=1.39'
          'perl-time-hires=1.9733'
          'perl-time-local=1.2300'
          'perl-time-piece=1.31'
          'perl-unicode-collate=1.14'
          'perl-unicode-normalize=1.25'
          'perl-version=0.9916'
          'perl-xsloader=0.21')
# Add your own provides here
provides=(${provides[@]})
source=(http://www.cpan.org/src/5.0/perl-${pkgver}.tar.bz2
        perlbin.sh
        perlbin.csh
        perl-binary-module-dependency-1.template)
options=('makeflags' '!purge' 'emptydirs')
md5sums=('99f39abe614b50719d9915431e54fc1e'
         '5ed2542fdb9a60682f215bd33701e61a'
         '1f0cbbee783e8a6d32f01be5118e0d5e'
         '2a366dfc783c460764cde0caf88a23af')

prepare() {
  cd ${srcdir}/${pkgname}-${pkgver}

  ln -sf libperl.so.${pkgver} libperl.so
  ln -sf libperl.so.${pkgver} libperl.so.5.24

  sed -i '' -e 's|%%PTHREAD_LIBS%%|-lpthread|g' \
                hints/freebsd.sh

  sed -i '' -e 's|/usr/local|/usr|g' \
                hints/freebsd.sh

}

build() {
  cd ${srcdir}/${pkgname}-${pkgver}

  if [ "${CARCH}" = "amd64" ]; then
    # for x86_64
    arch_opts="-Dcccdlflags='-fPIC'"
  else
    # for i386
    arch_opts=""
  fi

  ./Configure -sde -Dprefix=/usr \
     -Dlibperl=libperl.so.${pkgver} \
     -Dprefix=/usr -Dvendorprefix=/usr \
     -Dprivlib=/usr/share/perl5/core_perl \
     -Darchlib=/usr/lib/perl5/core_perl \
     -Dsitelib=/usr/share/perl5/site_perl \
     -Dsitearch=/usr/lib/perl5/site_perl \
     -Dvendorlib=/usr/share/perl5/vendor_perl \
     -Dvendorarch=/usr/lib/perl5/vendor_perl \
     -Dscriptdir=/usr/bin/core_perl \
     -Dsitescript=/usr/bin/site_perl \
     -Dvendorscript=/usr/bin/vendor_perl \
     -Dinc_version_list=none \
     -Ui_malloc -Ui_iconv -Uinstallusrbinperl \
     -Dusenm=n  -Dcc="cc" -Duseshrplib \
     -Dinc_version_list=none  -Dcf_by=perl \
     -Dcf_time="`env LANG=C /usr/bin/stat -t \"%a %b %d %T %Z %Y\" -f %Sm ${srcdir}/${pkgname}-${pkgver}.tar.bz2`" \
     -Alddlflags="-L${srcdir}/${pkgname}-${pkgver} -L/usr/lib/perl5/core_perl/CORE -Wl,-rpath=/usr/lib/perl5/core_perl/CORE -lperl" \
     -Dshrpldflags='$(LDDLFLAGS:N-L.:N-L/usr/lib/perl5/core_perl/CORE:N-Wl,-rpath=/usr/lib/perl5/core_perl/CORE:N-lperl) -Wl,-soname,$(LIBPERL:R)' \
     -Doptimize="-O2 -pipe -fstack-protector -fno-strict-aliasing" \
     -Ui_gdbm -Dusemultiplicity=y -Duse64bitint \
     -Dusethreads=y -Dusemymalloc=n

  make
}

#check() {
#  cd ${srcdir}/${pkgname}-${pkgver}
#  TEST_JOBS=$(echo $MAKEFLAGS | sed 's/.*-j\([0-9][0-9]*\).*/\1/') make test_harness
#  make test
#}

package() {
  cd ${srcdir}/${pkgname}-${pkgver}
  make DESTDIR="$pkgdir" install

  install -dm755 "$pkgdir/usr/share/makepkg-template"
  for template in "$srcdir/"*.template; do
    install -m644 "$template" "$pkgdir/usr/share/makepkg-template/${template##*/}"
  done
  ln -s perl-binary-module-dependency-1.template "$pkgdir/usr/share/makepkg-template/"perl-binary-module-dependency.template

  ### Perl Settings ###
  # Change man page extensions for site and vendor module builds.
  # Set no mail address since bug reports should go to the bug tracker
  # and not someone's email.
  gsed -e '/^man1ext=/ s/1perl/1p/' -e '/^man3ext=/ s/3perl/3pm/' \
      -e "/^cf_email=/ s/'.*'/''/" \
      -e "/^perladmin=/ s/'.*'/''/" \
      -i ${pkgdir}/usr/lib/perl5/core_perl/Config_heavy.pl

  ### CPAN Settings ###
  # Set CPAN default config to use the site directories.
  gsed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
      -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
      -i ${pkgdir}/usr/share/perl5/core_perl/CPAN/FirstTime.pm

  # Profile script to set paths to perl scripts.
  install -dm755 ${pkgdir}/etc/profile.d/
  install -m755 ${srcdir}/perlbin.sh \
                   ${pkgdir}/etc/profile.d/perlbin.sh
  # Profile script to set paths to perl scripts on csh. (FS#22441)
  install -m755 ${srcdir}/perlbin.csh \
                  ${pkgdir}/etc/profile.d/perlbin.csh

  # Add the dirs so new installs will already have them in PATH once they
  # install their first perl programm
  install -d -m755 "$pkgdir/usr/bin/vendor_perl"
  install -d -m755 "$pkgdir/usr/bin/site_perl"

  (cd ${pkgdir}/usr/bin; mv perl${pkgver} perl)
  (cd ${pkgdir}/usr/bin/core_perl;  ln -sf c2ph pstruct; ln -sf s2p psed)

  # Remove all pod files *except* those under /usr/share/perl5/core_perl/pod/
  # (FS#16488)
  rm -f $pkgdir/usr/share/perl5/core_perl/*.pod
  for d in $pkgdir/usr/share/perl5/core_perl/*; do
    if [ -d $d -a $(basename $d) != "pod" ]; then
      find $d -name *.pod -delete
    fi
  done
  find $pkgdir/usr/lib -name *.pod -delete
  find $pkgdir -name .packlist -delete

  #remove srcdir reference
  sed -i '' -e "s|-L${srcdir}/${pkgname}-${pkgver}||g" ${pkgdir}/usr/lib/perl5/core_perl/Config_heavy.pl
}

