# $Id$
# Maintainer:  Bart≈Çomiej Piotrowski <bpiotrowski@archlinux.org>
# Contributor: Allan McRae <allan@archlinux.org>
# Contributor: Aaron Griffin <aaron@archlinux.org>

pkgname=bash
_basever=4.3
_patchlevel=011 #prepare for some patches
pkgver=$_basever #.$_patchlevel
pkgrel=1
pkgdesc="The GNU Bourne Again shell"
arch=('i686' 'x86_64' 'amd64')
license=('GPL')
url="http://www.gnu.org/software/bash/bash.html"
backup=(etc/bash.bash{rc,_logout} usr/share/skel/.bash{rc,_profile,_logout})
depends=('gettext' 'freebsd-world')
install=bash.install
_port_patches=(
        patch-lib_readline_display.c
        extrapatch-colonbreakswords
        extrapatch-implicitcd)
source=(http://ftp.gnu.org/gnu/bash/bash-$_basever.tar.gz{,.sig}
        dot.bashrc
        dot.bash_profile
        dot.bash_logout
        system.bashrc
        system.bash_logout
        bash-4.3-test-nameref.patch
        "${_port_patches[@]}")
if [[ $_patchlevel -gt 000 ]]; then
    for (( p=1; p<=$((10#${_patchlevel})); p++ )); do
        source=(${source[@]} http://ftp.gnu.org/gnu/bash/bash-$_basever-patches/bash${_basever//./}-$(printf "%03d" $p){,.sig})
    done
fi

prepare() {
  cd "$srcdir/$pkgname-$_basever"

  for (( p=1; p<=$((10#${_patchlevel})); p++ )); do
    msg "applying patch bash${_basever//./}-$(printf "%03d" $p)"
    patch -p0 -i ../bash${_basever//./}-$(printf "%03d" $p)
  done

  # upstream patches I assume will be made official later...
  patch -p0 -i ../bash-4.3-debug-trap.patch
  patch -p0 -i ../bash-4.3-test-nameref.patch

  for i in "${_port_patches[@]}"; do
    msg "port patch $i"
    patch -p0 -i "${srcdir}/$i"
  done
}

build() {
  cd "${srcdir}/${pkgname}-$_basever"

  _bashconfig=(-DDEFAULT_PATH_VALUE=\'\"/usr/local/sbin:/usr/local/bin:/usr/bin\"\'
               -DSTANDARD_UTILS_PATH=\'\"/usr/bin\"\'
               -DSYS_BASHRC=\'\"/etc/bash.bashrc\"\'
               -DSYS_BASH_LOGOUT=\'\"/etc/bash.bash_logout\"\')
  export CFLAGS="${CFLAGS} ${_bashconfig[@]}"

  export LDFLAGS="-L/usr/local/lib,-rpath=/usr/local/lib $LDFLAGS"

  ./configure --prefix=/usr --with-curses --enable-readline \
    --without-bash-malloc \
    --sysconfdir=/etc --mandir=/usr/share/man \
    --enable-disabled-builtins
    #--with-installed-readline 
  gmake
}

#check() {
#  gmake -C $pkgname-$_basever check
#}

package() {
  cd "${srcdir}/${pkgname}-$_basever"
  gmake DESTDIR=${pkgdir} install

  rm ${pkgdir}/usr/share/info/dir

  # system-wide configuration files
  install -dm755 ${pkgdir}/etc
  install -m644 ${srcdir}/system.bashrc ${pkgdir}/etc/bash.bashrc
  install -m644 ${srcdir}/system.bash_logout ${pkgdir}/etc/bash.bash_logout

  # user configuration file skeletons
  install -dm755 ${pkgdir}/usr/share/skel/
  install -m644 ${srcdir}/dot.bashrc ${pkgdir}/usr/share/skel/dot.bashrc
  install -m644 ${srcdir}/dot.bash_profile ${pkgdir}/usr/share/skel/dot.bash_profile
  install -m644 ${srcdir}/dot.bash_logout ${pkgdir}/usr/share/skel/dot.bash_logout
}
sha1sums=('45ac3c5727e7262334f4dfadecdf601b39434e84'
          'SKIP'
          'a573cf76b3cdc72928add2585f68ca97b54b6d33'
          '672c3c0c28c3642a5cff0e4093ff98359c747ff0'
          '9fd0cfda5b85651169f8761a834941b1f6f53952'
          '895ffd3f5c729271859a659c4ca17aefc3fda927'
          '0bc4dc72ef407eefe27b6ba5b384ccddb3e0852b'
          '1d8bb5ce04af93bd74b8ce77991e777c6736bd60'
          '1858343fff9a9ef768a4030eb00dead16ede6084'
          '7860a622c34cdb74905a111be104098fab424f71'
          '264e31884f2ec09c817605dac8c38b9021a529f7'
          'd67ffd6833b30fd41f429205953714a184caa03b'
          'SKIP'
          '0c1d486387e5f3bea6a97b317de54f9c3de71c7c'
          'SKIP'
          '024d9a6dc6822bb5424f83478b495de29883fb3c'
          'SKIP'
          'ece4a6450842a5c13048b86ce1746576f1df7ccd'
          'SKIP'
          'e7745508829892e3627cef63e56299d584689e07'
          'SKIP'
          'df3e72bbca83bcac4513b3574d03ab25ac501928'
          'SKIP'
          '1394ecd50212d1bc192db5fbfbf08b996d2582a3'
          'SKIP'
          '482f9583f1a3a83256ded3c745cc3b98ccc9b3ea'
          'SKIP'
          '1909cd7f214f4ebedc60bf022132dd4e1284e65b'
          'SKIP'
          'd932228b23e795030132dc8eeea04d9919c90aa7'
          'SKIP'
          'c53032a18e6491c91117aff5a330620ed8db0f38'
          'SKIP')

