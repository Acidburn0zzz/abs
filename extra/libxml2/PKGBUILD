# $Id$
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Contributor: John Proctor <jproctor@prium.net>

pkgname=libxml2
pkgver=2.9.1
pkgrel=2
pkgdesc="XML parsing library, version 2"
arch=(i686 x86_64)
license=('custom')
depends=('pkgconf')
url="http://www.xmlsoft.org/"
port_patches=(
	patch-Makefile.in
	patch-config.h.in
	patch-configure
	patch-libxml-2.0-uninstalled.pc.in
	patch-libxml-2.0.pc.in
	patch-parser.c
	patch-python_Makefile.in
	patch-python_drv-libxml2.py
	patch-python_setup.py.in
	patch-python_tests_Makefile.in
	patch-xml2Conf.sh.in
)
source=(ftp://ftp.xmlsoft.org/${pkgname}/${pkgname}-${pkgver}.tar.gz
        http://www.w3.org/XML/Test/xmlts20080205.tar.gz
	${port_patches[@]})
md5sums=('9c0cfef285d5c4a5c80d00904ddab380'
         'b255be9a1c7f7021e52448e4ec8d7a0d'
         'e7ddc7e4b4d6e22defd8358f3dd7a767'
         '109f9152a285af70e6a581038bf5e23f'
         '04406c867041e434dcde7bb0aca48b82'
         'c7069039697d5f723da0930eca0c565c'
         '389000726874bacb25980152b99892cd'
         'ae009578382e7073ab680c3fd4a4a2fb'
         'dec781a34f2dcf1c4e95928d73d99a47'
         '7212f00541c0ad33c81ad42c240e925b'
         'a2df76d57b89fb64acc713c9be800419'
         '40c179289cff4b586aa6c7a85d96c03a'
         '03fb962c3b792a8bfd6e09497185dfd4')

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  for i in ${port_patches[@]}; do
    msg "Applying patch ${i}"
    patch -p0 -i "${srcdir}/${i}"
  done

  for d in . doc doc/devhelp doc/examples
  do
    sed -i '' -e '/^install-data-am:/ s|install-data-local||' \
      ${d}/Makefile.in
  done

  mtime=$(date -r $(stat -f '%m') '+%Y%m%d%H%M.%S')

  find  ${srcdir}/${pkgname}-${pkgver} -type f -name configure | xargs	touch -mt $mtime
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  ./configure  --prefix=/usr \
                --with-html-dir=/usr/share/doc \
		--with-iconv=/usr/local \
		--with-html-dir=/usr/sharedoc \
		--with-html-subdir=${pkgname} \
		--with-lzma=/usr \
		--without-python

  gmake
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  gmake DESTDIR="${pkgdir}" install

  mv "${pkgdir}/usr/etc" "${pkgdir}"
  install -dm755 "${pkgdir}/usr/share/licenses/${pkgname}/"
  install -m644  COPYING "${pkgdir}/usr/share/licenses/${pkgname}/"
}
