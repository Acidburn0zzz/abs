# $Id: PKGBUILD 172097 2012-11-28 10:31:12Z jgc $
# Maintainer: Jan de Groot <jgc@archlinux.org>

pkgname=('glib2' 'gio-fam')
pkgver=2.40.0
pkgrel=1
pkgdesc="Common C routines used by GTK+ and other libs"
url="http://www.gtk.org/"
arch=(i686 x86_64)
license=('LGPL')
makedepends=('pkgconf' 'python2' 'libxslt' 'docbook-xml' 'pcre' 'libffi' 'gsed' 'icu' 'gamin')
options=('!libtool' '!docs' '!emptydirs')
install=glib2.install
port_patches=(extra-patch-glib_Makefile.in
        extra-patch-glib_gunicollate.c
        patch-ae
        patch-config.h.in
        patch-docs_reference_Makefile.in
        patch-gio_gunixmount.c
        patch-gio_gunixmounts.c
        patch-gio_gunixvolume.c
        patch-gio_tests_include.c
        patch-gio_xdgmime_xdgmimecache.h
        patch-glib_Makefile.in
        patch-glib_gthread-posix.c
        patch-gmodule-gmodule-dl.c
        patch-gobject_Makefile.in
        patch-glib-2.0.pc.in)
source=(http://ftp.gnome.org/pub/GNOME/sources/glib/${pkgver%.*}/glib-$pkgver.tar.xz
        ${port_patches[@]}
        revert-warn-glib-compile-schemas.patch)

prepare() {
  cd "$srcdir/glib-$pkgver"

  for i in ${port_patches[@]};
  do
    msg "applying patch $i"
    patch -p0 -l -i "${srcdir}/$i"
  done

	sed -i '' -e '46i \
		#include <sys/socket.h>' gio/tests/gdbus-peer.c

  sed -i '' -e 's|inotify_support=yes|inotify_support=no| ; s|#define HAVE_SYS_INOTIFY_H 1||' configure

	patch -Rp1 -i ../revert-warn-glib-compile-schemas.patch

	sed -i '' \
      -e "/^ltmain=/!s|\$$ac_aux_dir/ltmain.sh|/usr/share/libtool/config/ltmain.sh|g" \
      -e "/^LIBTOOL=/s|\$$\(top_builddir\)/libtool|/usr/bin/libtool|g" \
      ${srcdir}/glib-${pkgver}/aclocal.m4
	find ${srcdir}/glib-${pkgver} -name "Makefile.in" | \
    xargs sed -i '' -e 's|^LIBTOOL[ ]*=.*|LIBTOOL=/usr/bin/libtool|g'
}

build() {
  cd "$srcdir/glib-$pkgver"

  unset CC CXX CPP

# fix FS#34630 https://bugs.archlinux.org/task/34630
  export CFLAGS+=" -Wall"

  sed -i '' -e 's|-liconv||g' configure
  PYTHON=/usr/bin/python2 ./configure --prefix=/usr --libdir=/usr/lib \
      --sysconfdir=/etc \
      --enable-static --enable-shared --with-libiconv=native \
      --disable-gtk-doc --with-html-dir=/usr/share/doc \
      --disable-man --without-xml-catalog \
      --disable-dtrace \
      --with-pcre=system \
      --target=$CHOST \
      --libexecdir=/usr/libexec \
      --with-libiconv=native \
      PTHREAD_CFLAGS="" \
      PTHREAD_LIBS="-pthread" \
      LDFLAGS="-lintl" ac_cv_header_sys_inotify_h=

  gmake
}

package_glib2() {
  depends=('pcre' 'libffi' 'python2' 'pkgconf' 'icu>=51.1')
  optdepends=('python2: for gdbus-codegen' 'gio-fam: FAM backend for GLibs GIO library')

  cd glib-$pkgver
  gmake completiondir=/etc/bash-completion.d DESTDIR="$pkgdir" install
  rm -f ${pkgdir}/usr/lib/gio/modules/libgiofam.{a,so}
  for _i in "$pkgdir/etc/bash-completion.d/"*; do
      chmod -x "$_i"
  done
  rm -rf "$pkgdir/usr/share/gdb/"
  rm -f "$pkgdir/usr/lib/charset.alias"
}

package_gio-fam() {
  pkgdesc="FAM backend for GLib's GIO library"
  depends=('glib2' 'gamin')

  cd glib-$pkgver/gio/fam/
  gmake completiondir=/etc/bash-completion.d DESTDIR="$pkgdir" install

}

md5sums=('05fb7cb17eacbc718e90366a1eae60d9'
         'd5fd208bddd974687d33e53c6a2d48fe'
         'a529fde3cb1dea8cbffd6de5044eae37'
         '9e71385308cf2e669a5aea75568ab5d7'
         'ffecdfa009194cdbe2478b913cab4ec2'
         'd07b3244bbb3b6424f3a285c3e9610d4'
         'fd3f07dd092ad800b5f819428d217ea5'
         '7fc99db2110b3cef9a92fb4b9dead172'
         'a06bc08a4fd7c53fd5107028f4b83660'
         'e56916089c7adbf071bb668ce9b03cb3'
         'a8afea050a1d00ee7caa60bec3f3ace8'
         '9edaff708112fb880ad398c6a63ba9dd'
         'ac96bee032a57a47485b782e71907b85'
         '2ee002bac221dcec813ad76ac276443f'
         '9607e464fd3aac5cd4b0fd0cb66bfbc7'
         '3f6bdb057cb55eca508b08af64054b23'
         'cde8e1a9d18918be0d90af67a981f184')

