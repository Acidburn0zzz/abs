# $Id: PKGBUILD 165016 2012-08-08 19:40:49Z andyrtr $
# Maintainer: AndyRTR <andyrtr@archlinux.org>

pkgname=ghostscript
pkgver=9.10
pkgrel=1
pkgdesc="An interpreter for the PostScript language"
arch=('i686' 'x86_64')
license=('GPL3' 'custom')
depends=('libxt' 'libcups' 'fontconfig' 'jasper' 'libpng>=1.5.7' 'libjpeg' 'libtiff>=4.0.0' 'lcms2')
makedepends=('gtk2') # 'gnutls')
optdepends=('texlive-core:      needed for dvipdf'
            'gtk2:              needed for gsx')
url="http://www.ghostscript.com/"
options=('!makeflags')
_port_patches=(
        patch-Resource-Init-FAPIcidfmap
        patch-Resource-Init-FAPIconfig
        patch-Resource-Init-cidfmap
        patch-Resource-Init-gs_statd.ps
        patch-Resource-Init-gs_ttf.ps
        patch-Resource-Init-pdf_font.ps
        patch-base-gs.mak
        patch-base-gsicc_create.c
        patch-base-gxobj.h
        patch-base-openjpeg.mak
        patch-base-unixinst.mak
        patch-contrib__japanese__dmp_site.ps
        patch-contrib__japanese__gdevdmpr.c
        patch-lips:gdevlips.c
        patch-lips:gdevlips.h
        patch-openjpeg-libopenjpeg-opj_includes.h
        patch-openjpeg-libopenjpeg-opj_malloc.h
        patch-psi-zicc.c
)
_old_patches=(
        patch-base-gdevl256.c
        patch-base-gdevperm.c
        patch-base-gdevplib.c
        patch-base-gdevvglb.c
        patch-base-unix-gcc.mak
        patch-contrib-contrib.mak
        )
source=(http://downloads.ghostscript.com/public/ghostscript-${pkgver}.tar.bz2
        "${_port_patches[@]}"
)

prepare() {
  cd ghostscript-${pkgver}

  for i in "${_port_patches[@]}"; do
    msg "patch $i"
    patch -p0 -i "${srcdir}/$i"
  done

  # force it to use system-libs
  # rm -rf jpeg libpng zlib jasper expat tiff lcms freetype 
  rm -rf jpeg libpng zlib jasper expat tiff lcms lcms2 freetype openjpeg cups/libs # jbig2dec is in community

  autoreconf
}

build() {
  cd ghostscript-${pkgver}

  ./configure --prefix=/usr \
	--enable-dynamic \
	--with-ijs \
	--with-jbig2dec \
	--without-omni \
	--with-x \
	--with-drivers=ALL \
	--with-fontpath=/usr/share/fonts/Type1:/usr/share/fonts:/usr/local/share/fonts \
	--with-install-cups \
	--enable-fontconfig \
	--enable-freetype \
	--without-luratech \
	--with-system-libtiff \
	--disable-compile-inits #--help # needed for linking with system-zlib
  export CFLAGS_STANDARD="${CFLAGS}"
  export SOC_LOADER="dxmainc.c"
  gmake

  # Build IJS
  cd ${srcdir}/ghostscript-${pkgver}/ijs
  sed -i '' -e 's@AM_PROG_CC_STDC@AC_PROG_CC_STDC@g' configure.ac
  ./autogen.sh
  ./configure --prefix=/usr --enable-shared --disable-static
  gmake
}

package() {
  cd ${srcdir}/ghostscript-${pkgver}
  gmake DESTDIR=${pkgdir} install soinstall \
   cups_serverroot=${pkgdir}/etc/cups \
   cups_serverbin=${pkgdir}/usr/lib/cups install soinstall

  # install missing doc files # http://bugs.archlinux.org/task/18023
  install -dm755 ${pkgdir}/usr/share/ghostscript/$pkgver/doc/
  for i in ${srcdir}/ghostscript-${pkgver}/doc/{Ps2ps2.htm,gs-vms.hlp,gsdoc.el,pscet_status.txt}
  do
    install -m644 "$i" ${pkgdir}/usr/share/ghostscript/$pkgver/doc/
  done
  
  mkdir -p ${pkgdir}/usr/share/licenses/${pkgname}
  install -m644 LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/

  # remove unwanted localized man-pages
  rm -rf $pkgdir/usr/share/man/[^man1]*

  # install IJS
  cd ${srcdir}/ghostscript-${pkgver}/ijs
  gmake DESTDIR=${pkgdir} install

}
sha1sums=('89527d45f97b6cf028ad8ca4bfa07c64462390e8'
          '611197579146b0b67937e1289c320769a93904dd'
          'b4ef428a7598f13643b0ccece2caa38eb56d280b'
          'c242f1faf02b64266a34cf71d4962ff77f28ffab'
          'd1dd7534a3eb43908d4f48782b3fea3768500c2e'
          'e8e317d74b38344ff4b0c090b5d29af30a3446cc'
          '52e95c7b39c873aab6ba8f7bce42a6c852774c0f'
          'bcc4cac29d5b5044d12eb9d972eb93a71f2f7f10'
          'b0264b21175bdec39513d6ed1360ae2b694ea1c3'
          'b005bd71ff72cad88e2f7c0d0de0fba7da8a55c2'
          'f8e8602f11891950e7a225677be0d3ddd3e48ae4'
          'b2018685bb046a0ca990b689320839dbda31e36a'
          '4aae73699c6210db924f08a5c4551f659f602672'
          '45db85055c3e80fc204bb6e67849b38553783cb9'
          '70cb3c8f1201698c9a55f51a47bff789bd8daafd'
          '59880a812ff26fb5a3c1426d7e09d13640c9ece9'
          'ef1479eda6425e50d2b04bfdeedcf08055e7544c'
          'ef530c35fdbd6e5251130438f36d761312e9a984'
          'e00c13f5cb8121a015b99f1049cb71c0ccb49bba')
