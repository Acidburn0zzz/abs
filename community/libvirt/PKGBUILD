# $Id$
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Jonathan Wiersma <archaur at jonw dot org>

pkgname=libvirt
pkgver=1.1.3
pkgrel=1
pkgdesc="API for controlling virtualization engines (openvz,kvm,qemu,virtualbox,xen,etc)"
arch=('i686' 'x86_64')
url="http://libvirt.org/"
license=('LGPL')
depends=('e2fsprogs' 'gnutls'  'libxml2'   'python2'
	 'avahi' 'polkit'  'libpciaccess'  'dbus-core' 'libxau' 'libxdmcp' 
	 'curl' 'libsasl' 'libgcrypt' 'libgpg-error' 'openssl' 'libxcb' 'gcc-libs'
	'libx11' 'libssh2' 'libgcrypt' 'libxml2' 'qemu' )
makedepends=( 'dnsmasq' 'automake' 'autoconf' 'gm4' 'perl')
optdepends=('bridge-utils: for briged networking (default)'
	    'dnsmasq: for NAT/DHCP for guests'
	    'openbsd-netcat: for remote management over ssh'
	    'radvd'
	    'dmidecode'
	    'ebtables')
options=('emptydirs' '!libtool')
backup=('etc/libvirt/libvirtd.conf'
	'etc/libvirt/qemu.conf'
	'etc/sasl2/libvirt.conf')
install="libvirt.install"
source=("http://libvirt.org/sources/$pkgname-$pkgver.tar.gz"
    	pie.patch
	configure.patch)


build() {
  cd "$srcdir/$pkgname-$pkgver"
  patch -p0 -i ${srcdir}/pie.patch
  patch -p0 -i ${srcdir}/configure.patch
  # python2 fix
  export PYTHON=`which python2`
  for file in $(find . -name '*.py' -print); do
    sed -i'' -e 's_#!.*/usr/bin/python_#!/usr/bin/python2_' $file
    sed -i'' -e 's_#!.*/usr/bin/env.*python_#!/usr/bin/env python2_' $file
  done
  export LDFLAGS=-lX11
  export RADVD=/usr/bin/radvd
 [ -f Makefile ] || ./configure --prefix=/usr --libexec=/usr/lib/"$pkgname" --sbindir=/usr/bin CFLAGS="${CFLAGS} -fPIC " \
		--with-qemu-user=nobody --with-qemu-group=nobody \
		--without-sasl \
		--without-yajl \
		--without-avahi \
		--without-hal \
		--without-udev \
		--without-netcf \
		--without-network \
		--without-sysctl \
		--enable-nls  --with-libintl-prefix=/usr \
		--with-pic  
  gmake

  #sed -i 's|#group =.*|group="kvm"|' src/qemu/qemu.conf
}

package() {
  cd "$srcdir/$pkgname-$pkgver"
  gmake DESTDIR="$pkgdir" install

  #install -dm755 "$pkgdir"/etc/conf.d/
  #install -m644 "$srcdir"/libvirtd-guests.conf.d "$pkgdir"/etc/conf.d/libvirt-guests
  #install -dm755 "$pkgdir"/etc/conf.d/libvirtd
  #install -m644 "$srcdir"/libvirtd.conf.d "$pkgdir"/etc/conf.d/libvirtd

  # systemd stuff
  #install -D -m644 "$srcdir"/libvirt.tmpfiles.d "$pkgdir"/usr/lib/tmpfiles.d/libvirt.conf
  #mv "$pkgdir"/lib/* "$pkgdir"/usr/lib/
  rm "$pkgdir"/usr/lib/charset.alias
  #rm -rf \
  #	"$pkgdir"/var/run \
  #	"$pkgdir"/etc/sysconfig \
  #	"$pkgdir"/etc/rc.d/init.d \
  #	"$pkgdir"/lib \
#	"$pkgdir"/etc/sysctl.d
}
md5sums=('b0dfe373ebe0c588b42a28c14d36a3e6'
         'ac10267fcb19be9437ec5760237a6c57'
         'dde2f6ef16eba249051a3a27f0a37832')
